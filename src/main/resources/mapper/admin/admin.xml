<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pcwk.ehr.admin">

  <sql id="searchCondition">
     <where>
        <choose>
            <when test="searchDiv == '10' and '' != searchDiv">
              category_nm LIKE #{searchWord} || '%'
            </when>
            <when test="searchDiv == '20' and '' != searchDiv">
              status LIKE #{searchWord} || '%'
            </when>
        </choose>
     </where>
  </sql>
    
  <select id="doRetrieveCategory" resultType="CategoryVO" parameterType="SearchVO">
      SELECT A.*,B.*
      FROM(
          SELECT TT1.RNUM as num,
                 tt1.category_no as "categoryNo",
                 TT1.category_nm as "categoryNm",
                 -- 당일이면 시:분, 그렇지 않으면 년-월-일
                 DECODE( TO_CHAR(SYSDATE,'YYYY-MM-DD'),  TO_CHAR(TT1.reg_dt,'YYYY-MM-DD')
                        ,TO_CHAR(TT1.reg_dt,'HH24:MI')
                        ,TO_CHAR(TT1.reg_dt,'YYYY-MM-DD')) as regDt,
                 DECODE( TO_CHAR(SYSDATE,'YYYY-MM-DD'),  TO_CHAR(TT1.mod_dt,'YYYY-MM-DD')
                        ,TO_CHAR(TT1.mod_dt,'HH24:MI')
                        ,TO_CHAR(TT1.mod_dt,'YYYY-MM-DD')) as modDt,
                TT1.status
          FROM (
              SELECT ROWNUM AS RNUM, T1.*
              FROM (
                  SELECT *
                  FROM category
                  -- WHERE 조건 (검색구분:''(전체), 10(category_nm), 20(status), 검색어)
                 <include refid="searchCondition"/>
                  ORDER BY reg_dt
              ) T1
              -- 종료 번호
              <![CDATA[ WHERE ROWNUM <= #{pageSize} * (#{pageNo} - 1) + #{pageSize} ]]>
          ) TT1
          -- 시작번호
          <![CDATA[ WHERE ROWNUM >= #{pageSize} * (#{pageNo} - 1) + 1 ]]>
      ) A
      CROSS JOIN
      (
          SELECT COUNT(*) totalCnt
          FROM category
          --WHERE 조건
          <include refid="searchCondition"/>
      ) B
   </select>
   
  <insert id="doSaveCategory" parameterType="CategoryVO">
    INSERT INTO category (
      category_no,
      category_nm
    ) VALUES (
      #{categoryNo},
      #{categoryNm}
    )
  </insert>

  <update id="doUpdateCategory" parameterType="CategoryVO">
      <![CDATA[
      UPDATE category
      SET category_nm = #{categoryNm},
          status  = #{status},
          mod_dt = SYSDATE
      WHERE category_no = #{categoryNo}
      ]]>
  </update>

  <!-- mybatis-config.xml에 alias 설정했기때문에 parameterType 풀경로X -->
  <delete id="doDeleteCategory" parameterType="CategoryVO">
    DELETE FROM category
    WHERE CATEGORY_NO = #{categoryNo}
  </delete>  <!-- #{categoryNo} 는 CategoryVO의 멤버변수명 -->

</mapper>
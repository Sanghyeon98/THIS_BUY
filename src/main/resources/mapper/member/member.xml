<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.member">
    <!-- id중복 체크 -->
    <select id="idCheck" parameterType="MemberVO" resultType="int">
        SELECT COUNT(*) AS cnt
        FROM hr_member
        WHERE u_Id = #{uId}
    </select>

    <!-- 회원목록 조회 -->
    <sql id="searchConditionMember">
        <where>
            <choose>
                <when test=" '10' == searchDiv and '' != searchWord  ">
                    u_Id LIKE #{searchWord} || '%'
                </when>
                <when test=" '20' == searchDiv and '' != searchWord  ">
                    name LIKE #{searchWord} || '%'
                </when>
                <when test=" '30' == searchDiv and '' != searchWord  ">
                    email LIKE #{searchWord} || '%'
                </when>
            </choose>
        </where>
    </sql>


    <select id="doRetrive" resultType="MemberVO"
        parameterType="SearchVO">

        SELECT A.*,B.*
        FROM (
            SELECT TT1. u_id ,
                TT1. name ,
                TT1. email ,
                TT1. phone ,
                TT1. address ,
                TT1. gender ,
                TT1. birthdate ,
                TT1. reg_dt ,
                TT1. mod_dt ,
                TT1. auth ,
                --당일이면 시:분, 그렇치 않으면 년/월/일
                DECODE( TO_CHAR(SYSDATE,'YYYY-MM-DD'), TO_CHAR(TT1.reg_dt,'YYYY-MM-DD')
                ,TO_CHAR(TT1.reg_dt,'HH24:MI')
                ,TO_CHAR(TT1.reg_dt,'YYYY-MM-DD')) as regDt
            FROM (
                SELECT ROWNUM AS RNUM,T1.*
                FROM (
                SELECT *
                FROM hr_member
                --WHERE 조건(검색구분:''(전체),10(u_id),20(name),30(email), 검색어)
                <include refid="searchConditionMember" />
                ORDER BY reg_dt DESC
                )T1
                --종료 번호
                <![CDATA[  WHERE ROWNUM <= #{pageSize} * (#{pageNo} - 1) + #{pageSize} ]]>
            )TT1
            --시작번호
                <![CDATA[  WHERE RNUM >= #{pageSize} * (#{pageNo} - 1)+1 ]]>
        )A
        CROSS JOIN
        (
            SELECT COUNT(*) totalCnt
            FROM hr_member
            --WHERE 조건
            <include refid="searchConditionMember" />
        )B

    </select>

    <update id="doUpdate" parameterType="MemberVO">
        UPDATE hr_member
        SET 
            passwd = #{passwd},
            name = #{name},
            email = #{email},
            phone = #{phone},
            address = #{address},
            gender = #{gender},
            birthdate = SYSDATE,
            reg_dt = SYSDATE,
            mod_dt = SYSDATE,
            auth = #{auth}
        WHERE u_id = #{uId}
    </update>

    <!-- resultMap -->
    <!-- column : DB컬럼 property: VO 프로퍼티명 jdbcType: DB컬럼 타입 type: VO -->
    <resultMap type="MemberVO" id="userMap">
        <result column="u_id" property="uId" />
        <result column="passwd" property="passwd" />
        <result column="name" property="name" />
        <result column="email" property="email" />
        <result column="phone" property="phone" />
        <result column="address" property="address" />
        <result column="gender" property="gender" />
        <result column="birthdate" property="birthdate" />
        <result column="reg_dt" property="regDt" />
        <result column="mod_dt" property="modDt" />
        <result column="auth" property="auth" />
    </resultMap>


    <select id="doSelectOne" parameterType="MemberVO" resultMap="userMap">
        <![CDATA[ 
         SELECT u_id        ,
                passwd      ,
                email       ,
                phone       ,
                address     ,
                gender      ,
                TO_CHAR(reg_dt,'yyyy-mm-dd hh24:mi:ss') AS birthdate   ,
                TO_CHAR(reg_dt,'yyyy-mm-dd hh24:mi:ss') AS reg_dt      ,
                TO_CHAR(reg_dt,'yyyy-mm-dd hh24:mi:ss') AS mod_dt      ,
                auth      
        FROM hr_member    
        WHERE u_id = #{uId}
        ]]>
    </select>
    <!-- parameterType, resultType 자바 타입의 내장된 별칭 사용 가능 Java Mybatis (소문자) String 
        -> string Integer -> int, integer Map -> map HashMap -> hashmap Collection 
        -> collection ArrayList -> arraylist 파라메터 설정 ${}, #{} ${} : 자동으로 데이터 타입 처리(PreparedStatement방식) 
        #{} : 문자열 처리를 해주지 않는다.(Statement방식) -->
    <select id="getCount" parameterType="memberVO" resultType="int">
        SELECT COUNT(*) cnt
        FROM hr_member
        WHERE u_id LIKE #{uId} || '%'
    </select>
    <select id="getAll" parameterType="memberVO"
        resultType="memberVO">
        SELECT u_id AS "uId",
        passwd,
        name,
        email,
        phone,
        address,
        gender,
        TO_CHAR(reg_dt,'yyyy-mm-dd hh24:mi:ss') AS birthdate,
        TO_CHAR(reg_dt,'yyyy-mm-dd hh24:mi:ss') AS regDt
        FROM hr_member
        WHERE u_id like #{uId} || '%'
        ORDER BY u_id
    </select>

    <insert id="doSave" parameterType="memberVO">
        INSERT INTO hr_member (
        u_id ,
        passwd ,
        name  ,
        email ,
        phone ,
        address ,
        gender ,
        birthdate ,
        reg_dt ,
        mod_dt ,
        auth
        ) VALUES (
        #{uId},
        #{passwd},
        #{name},
        #{email},
        #{phone},
        #{address},
        #{gender},
        SYSDATE,
        SYSDATE,
        SYSDATE,
        #{auth}
        )
    </insert>

    <delete id="doDelete" parameterType="MemberVO">
        DELETE FROM hr_member
        WHERE u_Id = #{uId}
    </delete>

</mapper>  
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pcwk.ehr.board">
	
	<resultMap type="QuestionVO" id="questionResult">
	
		<id 	property="seq" 	 column="seq"	/>	
		<result property="gubun" 	     column="gubun"		/>
		<result property="title"	 	 column="title"  		/>
		<result property="contents"  		 column="contents"			/>
		<result property="regDt" 	 column="reg_dt"		/>
		<result property="regId" 		 column="reg_id"		/>
		<result property="answerCheck"   column="answer_check"	/>
		
	</resultMap>
	
	
	<!-- answerCheck -->
	<!-- 답변수가 0보다 많으면, QUESTION 테이블의 answer_check 칼럼이 0 -> 1로 변함.. 현재 doSelectOne시 갱신, 답변 insert시 발동가능하게 하길.. -->
	<update id="answerCheck" parameterType="Answer">
	
		UPDATE board
		SET answer_check = 1
		WHERE EXISTS (
		        SELECT A.cnt
		        FROM(SELECT COUNT(*) cnt
		            FROM  answer
		            WHERE question_no = #{questionNo}) A
		        WHERE A.cnt > 0
		        )
		AND seq = #{seq}   
	
	</update>
	
	<!-- doRetrieve 카테고리 : 10 (공지사항), 20(1:1 문의 )   -->
	<sql id="searchCondition">
		<where>
			<choose>
				<when test=" '10'  == searchDiv ">
					gubun = #{searchWord}    
				</when>
				<when test=" '20'  == searchDiv ">
				</when>
			</choose> 
		</where>
	</sql>
	
	
	<!-- doRetrieve -->
	<select id="doRetrieve" parameterType="Search" resultType="QuestionVO">

		 SELECT A.*,                                                                                                                    
		        B.*                                                                                                                      
		 FROM(    
		        SELECT t2.seq 			AS num,             
		        	   t2.gubun 	AS questionNo, 		                                                                                                     
		               t2.title 		AS orderNo, 		                                                                                                       
		               t2.contents 		AS qUser,                                                                                                       
		               t2.reg_id			AS regId,                                   			                                                                                                                                                                                                                                                                                                                                                                         
		               DECODE(TO_CHAR(SYSDATE, 'YYYYMMDD'), TO_CHAR(t2.reg_dt, 'YYYYMMDD')
		                          , TO_CHAR(t2.reg_dt, 'HH24:MI')             
		                          , TO_CHAR(t2.reg_dt, 'YYYYMMDD')) AS regDt,
		               t2.answer_check  AS answerCheck           
		         FROM(                                                                                                                
		             SELECT ROWNUM rnum                                                                                                 
		                     , t1.*                                                                                                     
		             FROM(SELECT *                                                                                                      
		                  FROM question                                                                                                                                               
		                  ORDER BY question_no DESC ) t1  
		              <include refid="searchCondition" />                                                                                 
		             )t2 
		         WHERE rnum BETWEEN #{pageSize} * (#{pageNum} - 1) + 1 AND #{pageSize} * (#{pageNum} - 1) + #{pageSize}
		     )A                                                                                                                         
		 CROSS JOIN                                                                                                                     
		     (SELECT COUNT(*) totalCnt                                                                                                 
		     FROM question          
		     <include refid="searchCondition" />                                                                                                      
		     )B     

	                                                                                                                                                                         															
       <!--  WHERE rnum BETWEEN #{pageSize} * (#{pageNum} - 1) + 1 AND #{pageSize} * (#{pageNum} - 1) + #{pageSize} -->
	
	</select>
	
	
	<select id="doSelectOne" parameterType="QuestionVO" resultMap="questionResult">
		
		SELECT seq, 	            					  
			   gubun,	                					   			  
			   title,			                   				  
			   contents,	
			   reg_id,	                   				  	 	                   				  	    				  
			   TO_CHAR(reg_dt, 'YYYY/MM/DD HH24MISS') reg_dt,	   
			   answer_check 			  
		FROM   seq                  					  
		WHERE seq = #{seq}
		ORDER BY seq
		
	</select>
	
	
	<!-- doUpdate -->
	<update id = "doUpdate" parameterType="QuestionVO">
		UPDATE question
		SET   title = #{title}
		    , contents = #{contents}
		    , reg_dt = SYSDATE
		WHERE question_no = #{questionNo}
		
	</update>
	
	
	<!-- doDelete -->
	<delete id = "doDelete" parameterType="QuestionVO">
	
		DELETE FROM board
		WHERE seq = #{seq}
	
	</delete>


	<!-- doInsert -->	
	<insert id = "doInsert" parameterType="QuestionVO">
		
		INSERT INTO question (
		    seq,
		    gubun,
		    title,
		    contents,
		    reg_dt,
		    reg_id
		) VALUES (
		    seq_SEQ.NEXTVAL,
		    #{gubun},
		    #{title},
		    #{contents},
		    SYSDATE,
		    #{reg_id}
		)
	
	</insert>
</mapper>
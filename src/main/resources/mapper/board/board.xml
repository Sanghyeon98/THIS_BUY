<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pcwk.ehr.board">

	<sql id="searchCondition">
    <where>
      <choose>
        <when test=" '10'  == searchDiv ">
          gubun = #{searchWord}    
        </when>
        <when test=" '20'  == searchDiv ">
        </when>
      </choose> 
    </where>
  </sql>
  
	
	<!-- doDelete -->
	<delete id = "doDelete" parameterType="BoardVO">
	
		DELETE FROM board
		WHERE seq = #{seq}
	
	</delete>

	<!-- doInsert -->	
	<insert id = "doInsert" parameterType="BoardVO">
		
		INSERT INTO board (
		    seq,
		    gubun,
		    title,
		    contents,
		    reg_dt,
		    reg_id
		) VALUES (
		    #{seq},
		    #{gubun},
		    #{title},
		    #{contents},
		    SYSDATE,
		    #{regId}
		)
	
	</insert>
	
	<!-- doUpdate -->
  <update id = "doUpdate" parameterType="BoardVO">
    UPDATE board
    SET   title = #{title}
        , contents = #{contents}
        , reg_dt = SYSDATE
    WHERE seq = #{seq}
    
  </update>
  
  <!-- doRetrieve -->
  <select id="doRetrieve" parameterType="com.pcwk.ehr.cmn.SearchVO" resultType="BoardVO">

     SELECT A.*,                                                                                                                    
            B.*                                                                                                                      
     FROM(    
            SELECT t2.rnum      AS num,  
                  t2.gubun AS gubun           
                 t2.seq ,                                                                                                         
                   t2.title ,                                                                                                            
                   t2.contents    AS contents,                                                                                                       
                   t2.title     AS title,                                                                                               
                   t2.contents    AS contents,                                                                                                                                                                                                                                                                                                                                                                                     
                   DECODE(TO_CHAR(SYSDATE, 'YYYYMMDD'), TO_CHAR(t2.reg_dt, 'YYYYMMDD')
                              , TO_CHAR(t2.reg_dt, 'HH24:MI')             
                              , TO_CHAR(t2.reg_dt, 'YYYYMMDD')) AS regDt,
                   t2.reg_id AS regId
                   t2.answer_check  AS answerCheck           
             FROM(                                                                                                                
                 SELECT ROWNUM rnum                                                                                                 
                         , t1.*                                                                                                     
                 FROM(SELECT *                                                                                                      
                      FROM board                                                                                                                                               
                      ORDER BY seq DESC ) t1  
                  <include refid="searchCondition" />                                                                                 
                 )t2 
             WHERE rnum BETWEEN #{pageSize} * (#{pageNum} - 1) + 1 AND #{pageSize} * (#{pageNum} - 1) + #{pageSize}
         )A                                                                                                                         
     CROSS JOIN                                                                                                                     
         (SELECT COUNT(*) totalCnt                                                                                                 
         FROM board          
         <include refid="searchCondition" />                                                                                                      
         )B     

                                                                                                                                                                                                        
       <!--  WHERE rnum BETWEEN #{pageSize} * (#{pageNum} - 1) + 1 AND #{pageSize} * (#{pageNum} - 1) + #{pageSize} -->
  
  </select>
  
  <select id="doSelectOne" parameterType="BoardVO" >
    
    SELECT seq,                           
          gubun,
          title,
          contents,
          reg_id,                                                                               
          TO_CHAR(reg_dt, 'YYYY/MM/DD HH24MISS') reg_dt,    
          answer_check         
    FROM   board                             
    WHERE seq = #{seq}
    ORDER BY board
    
  </select>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pcwk.ehr.board">

<sql id="searchConditionboard">
     <where>
        <choose>
            <when test="searchDiv == '10' and '' != searchDiv">
              gubun LIKE #{searchWord} || '%'
            </when>
            <when test="searchDiv == '20' and '' != searchDiv">
              reg_id LIKE #{searchWord} || '%'
            </when>
        </choose>
     </where>
  </sql>
    
  <select id="doRetrieve" resultType="BoardVO" parameterType="SearchVO">
      SELECT A.*,B.*
      FROM(
          SELECT 
                 TT1.seq as seq,
                 TT1.gubun as "gubun",
                 TT1.title as "title",
                 TT1.contents as "contents",
                 -- 당일이면 시:분, 그렇지 않으면 년-월-일
                 DECODE( TO_CHAR(SYSDATE,'YYYY-MM-DD'),  TO_CHAR(TT1.reg_dt,'YYYY-MM-DD')
                        ,TO_CHAR(TT1.reg_dt,'HH24:MI')
                        ,TO_CHAR(TT1.reg_dt,'YYYY-MM-DD')) as regDt,
                TT1.reg_id
          FROM (
              SELECT ROWNUM AS RNUM, T1.*
              FROM (
                  SELECT *
                  FROM board
                 <include refid="searchConditionboard"/>
                  ORDER BY reg_dt DESC
              ) T1
              -- 종료 번호
              <![CDATA[ WHERE ROWNUM <= #{pageSize} * (#{pageNo} - 1) + #{pageSize} ]]>
          ) TT1
          -- 시작번호
          <![CDATA[ WHERE ROWNUM >= #{pageSize} * (#{pageNo} - 1) + 1 ]]>
      ) A
      CROSS JOIN
      (
          SELECT COUNT(*) totalCnt
          FROM board
          --WHERE 조건
          <include refid="searchConditionboard"/>
      ) B
   </select>
  
  <!-- doDelete -->
  <delete id = "doDelete" parameterType="BoardVO">
  
    DELETE FROM board
    WHERE seq = #{seq}
  
  </delete>

  <!-- doInsert --> 
  <insert id = "doInsert" parameterType="BoardVO">
    
    INSERT INTO board (
        seq,
        gubun,
        gubun_question,
        title,
        contents,
        reg_dt,
        reg_id,
        answer_check
    ) VALUES (
        #{seq},
        #{gubun},
        #{gubunQuestion},
        #{title},
        #{contents},
        SYSDATE,
        #{regId},
        #{answerCheck}
    )
  
  </insert>
  
  <!-- doUpdate -->
  <update id = "doUpdate" parameterType="BoardVO">
    UPDATE board
    SET   title = #{title}
        , contents = #{contents}
        , reg_dt = SYSDATE
    WHERE seq = #{seq}
  </update>
  
    <sql id="searchCondition">
    <where>
      <choose>
        <when test=" '10'  == searchDiv ">
          gubun = #{searchWord}    
        </when>
        <when test=" '20'  == searchDiv ">
        </when>
      </choose> 
    </where>
  </sql>
  
    <resultMap type="BoardVO" id="boardMap">
   <result  column="seq"      property="seq"       />
   <result  column="gubun"      property="gubun"      />
   <result  column="gubun_question"      property="gubunQuestion"      />
   <result  column="title"    property="title"    />
   <result  column="contents"   property="contents"  />
   <result  column="reg_dt"     property="regDt"     />
   <result  column="reg_id" property="regId" />
   <result  column="answer_check"     property="answerCheck"     />
  </resultMap> 
   

  
  <select id="doSelectOne" parameterType="BoardVO" resultMap="boardMap">
    
    SELECT seq,                           
          gubun,
          gubun_question,
          title,
          contents,
          reg_id,                                                                               
          TO_CHAR(reg_dt, 'YYYY/MM/DD HH24MISS') reg_dt ,
          answer_check  as answerCheck
    FROM   board                             
    WHERE seq = #{seq}
    ORDER BY seq
    
  </select>
</mapper>